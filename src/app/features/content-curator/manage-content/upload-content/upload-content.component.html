<div class="signin-main">
  <div class="h1-button">
    <h1>UPLOAD NEW CONTENT</h1>
    <div class="action-button">
      <button
        class="close-button"
        mat-icon-button
        (click)="close()"
        matTooltip="close"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
  <mat-divider></mat-divider>
  <form [formGroup]="uploadForm">
    <!-- Title -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Title</mat-label>
      <input
        matInput
        type="text"
        formControlName="title"
        placeholder="Enter title"
      />
      @if (titleErrorMessage()) {
      <mat-error>{{ titleErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Description -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Description</mat-label>
      <textarea
        matInput
        formControlName="description"
        rows="4"
        placeholder="Enter description"
      ></textarea>
      @if(descriptionErrorMessage()) {
      <mat-error>{{ descriptionErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Category -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Category</mat-label>
      <mat-select formControlName="category" placeholder="Select category">
        <mat-option value="theater">Theater</mat-option>
        <mat-option value="film">Film</mat-option>
        <mat-option value="music">Music</mat-option>
        <mat-option value="dance">Dance</mat-option>
        <mat-option value="education">Education</mat-option>
        <mat-option value="ccpspecials">CCP Specials</mat-option>
        <mat-option value="ccpclassics">CCP Classics</mat-option>
      </mat-select>
      @if(categoryErrorMessage()) {
      <mat-error>{{ categoryErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Sub Category -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Sub Category</mat-label>
      <input
        matInput
        type="text"
        formControlName="subcategory"
        placeholder="Enter Sub Category"
      />
      @if(subCategoryErrorMessage()) {
      <mat-error>{{ subCategoryErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Director -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Director</mat-label>
      <input
        matInput
        type="text"
        formControlName="director"
        placeholder="Enter director name"
      />
      @if(directorErrorMessage()) {
      <mat-error>{{ directorErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Writer -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Writer</mat-label>
      <input
        matInput
        type="text"
        formControlName="writer"
        placeholder="Enter writer name"
      />
      @if(writerErrorMessage()) {
      <mat-error>{{ writerErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Year Released -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>Year Released</mat-label>
      <input
        matInput
        type="number"
        formControlName="yearreleased"
        placeholder="Enter year released"
        min="1900"
        [max]="currentYear"
      />
      @if(yearReleasedErrorMessage()) {
      <mat-error>{{ yearReleasedErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- User Type -->
    <mat-form-field appearance="outline" class="form-field-container">
      <mat-label>For which User Type?</mat-label>
      <mat-select formControlName="usertype">
        <mat-option value="free">Free</mat-option>
        <mat-option value="subscriber">Subscriber</mat-option>
      </mat-select>
      @if(userTypeErrorMessage()) {
      <mat-error>{{ userTypeErrorMessage() }}</mat-error>
      }
    </mat-form-field>

    <!-- Custom Fields -->
    <div class="form-field-container">
      <label
        >Custom Fields
        <button
          type="button"
          mat-icon-button
          (click)="addCustomField()"
          matTooltip="Add Field"
        >
          <mat-icon>add</mat-icon>
        </button></label
      >

      <div formArrayName="customFields">
        @for (customField of customFieldsFormArray.controls; track $index) {
        <div class="custom-field" [formGroupName]="$index">
          <div class="field">
            <mat-form-field appearance="outline" style="flex: 1">
              <mat-label>Field Name</mat-label>
              <mat-select formControlName="fieldId">
                @for (field of getAvailableFields($index); track field.id) {
                <mat-option [value]="field.id">{{
                  field.fieldName
                }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" style="flex: 1">
              <mat-label>Value</mat-label>
              <input
                matInput
                type="text"
                formControlName="value"
                placeholder="Enter value"
              />
            </mat-form-field>
            <button
              type="button"
              mat-icon-button
              (click)="removeCustomField($index)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>
      @if (customFieldsErrorMessage()) {
      <mat-error>{{ customFieldsErrorMessage() }}</mat-error>
      }
    </div>

    <!-- Landscape Image -->
    <div class="form-field-container upload-section">
      <label for="landscapeImage" class="upload-label">
        <mat-icon>landscape</mat-icon>
        Landscape Image
      </label>
      @if (landscapeImageKey && uploadProgress['landscape'] === 100) {
      <div class="existing-file">
        <div class="file-info">
          <mat-icon>image</mat-icon>
          <span>{{ landscapeImageKey.split("/").pop() }}</span>
        </div>
        <button
          mat-icon-button
          matTooltip="remove"
          (click)="
            deleteMedia(
              landscapeImageKey,
              'landscapeFileURL',
              'landscapeImageKey'
            )
          "
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      } @else if (uploadProgress['landscape'] && uploadProgress['landscape'] > 0
      && uploadProgress['landscape'] < 100) {
      <div class="progress">
        <div class="progress-header">
          <mat-icon>cloud_upload</mat-icon>
          <span>Uploading landscape image...</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="uploadProgress['landscape']"
        >
        </mat-progress-bar>
        <div class="progress-info">
          @if (uploadProgress["landscape"] !== 100) {
          <div class="upload-controls">
            @if (!isPaused['landscape']) {
            <button
              mat-icon-button
              (click)="pauseUpload(landscapeImageKey, 'landscape')"
              [disabled]="uploadProgress['landscape'] === 100"
              matTooltip="Pause upload"
            >
              <mat-icon>pause</mat-icon>
            </button>
            } @else {
            <button
              mat-icon-button
              (click)="resumeUpload(landscapeImageKey, 'landscape')"
              [disabled]="uploadProgress['landscape'] === 100"
              matTooltip="Resume upload"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            }
            <button
              mat-icon-button
              (click)="cancelUpload(landscapeImageKey, 'landscape')"
              [disabled]="uploadProgress['landscape'] === 100"
              matTooltip="Cancel upload"
            >
              <mat-icon>cancel</mat-icon>
            </button>
          </div>
          }
          <p>
            <span
              >{{
                uploadProgress["landscape"] === 100 ? "Uploaded" : "Uploading"
              }} </span
            >{{ uploadProgress["landscape"] }}%
          </p>
        </div>
      </div>
      } @else {
      <div
        class="upload-area"
        (click)="triggerFileInput('landscapeImage')"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'landscape')"
      >
        <input
          type="file"
          #landscapeFileInput
          id="landscapeImage"
          formControlName="landscapeimage"
          (change)="onLandscapeImageSelected($event)"
          accept="image/*"
          class="form-control-file"
        />
      </div>

      } @if (landscapeErrorMessage()) {
      <mat-error>{{ landscapeErrorMessage() }}</mat-error>
      } @if (landscapeFileURL) {
      <div class="preview-container">
        <img
          class="previewMedia"
          [src]="landscapeFileURL"
          alt="Landscape preview"
        />
      </div>
      }
    </div>

    <!-- Portrait Image -->
    <div class="form-field-container upload-section">
      <label for="portraitImage" class="upload-label">
        <mat-icon>portrait</mat-icon>
        Portrait Image
      </label>
      @if (portraitImageKey && uploadProgress['portrait'] === 100) {
      <div class="existing-file">
        <div class="file-info">
          <mat-icon>image</mat-icon>
          <span>{{ portraitImageKey.split("/").pop() }}</span>
        </div>
        <button
          mat-icon-button
          matTooltip="remove"
          (click)="
            deleteMedia(portraitImageKey, 'portraitFileURL', 'portraitImageKey')
          "
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      } @else if (uploadProgress['portrait'] && uploadProgress['portrait'] > 0
      && uploadProgress['portrait'] < 100) {
      <div class="progress">
        <div class="progress-header">
          <mat-icon>cloud_upload</mat-icon>
          <span>Uploading portrait image...</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="uploadProgress['portrait']"
        >
        </mat-progress-bar>
        <div class="progress-info">
          @if (uploadProgress["portrait"] !== 100) {
          <div class="upload-controls">
            @if (!isPaused['portrait']) {
            <button
              mat-icon-button
              (click)="pauseUpload(portraitImageKey, 'portrait')"
              [disabled]="uploadProgress['portrait'] === 100"
              matTooltip="Pause upload"
            >
              <mat-icon>pause</mat-icon>
            </button>
            } @else {
            <button
              mat-icon-button
              (click)="resumeUpload(portraitImageKey, 'portrait')"
              [disabled]="uploadProgress['portrait'] === 100"
              matTooltip="Resume upload"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            }
            <button
              mat-icon-button
              (click)="cancelUpload(portraitImageKey, 'portrait')"
              [disabled]="uploadProgress['portrait'] === 100"
              matTooltip="Cancel upload"
            >
              <mat-icon>cancel</mat-icon>
            </button>
          </div>
          }
          <p>
            <span
              >{{
                uploadProgress["portrait"] === 100 ? "Uploaded" : "Uploading"
              }} </span
            >{{ uploadProgress["portrait"] }}%
          </p>
        </div>
      </div>
      } @else {
      <div
        class="upload-area"
        (click)="triggerFileInput('portraitImage')"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'portrait')"
      >
        <input
          type="file"
          #portraitFileInput
          id="portraitImage"
          formControlName="portraitimage"
          (change)="onPortraitImageSelected($event)"
          accept="image/*"
          class="form-control-file"
        />
      </div>
      } @if (portraitErrorMessage()) {
      <mat-error>{{ portraitErrorMessage() }}</mat-error>
      } @if (portraitFileURL) {
      <div class="preview-container">
        <img
          class="previewMedia"
          [src]="portraitFileURL"
          alt="Portrait preview"
        />
      </div>
      }
    </div>

    <!-- Preview Video -->
    <div class="form-field-container upload-section">
      <label for="previewVideo" class="upload-label">
        <mat-icon>movie</mat-icon>
        Preview Video
      </label>
      @if (previewVideoKey && uploadProgress["preview"] === 100) {
      <div class="existing-file">
        <div class="file-info">
          <mat-icon>video_file</mat-icon>
          <span>{{ previewVideoKey.split("/").pop() }}</span>
        </div>
        <button
          mat-icon-button
          matTooltip="remove"
          (click)="
            deleteMedia(previewVideoKey, 'previewFileURL', 'previewVideoKey')
          "
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      } @else if (uploadProgress['preview'] && uploadProgress['preview'] > 0 &&
      uploadProgress['preview'] < 100) {
      <div class="progress">
        <div class="progress-header">
          <mat-icon>cloud_upload</mat-icon>
          <span>Uploading preview video...</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="uploadProgress['preview']"
        >
        </mat-progress-bar>
        <div class="progress-info">
          @if (uploadProgress["preview"] !== 100) {
          <div class="upload-controls">
            @if (!isPaused['preview']) {
            <button
              mat-icon-button
              (click)="pauseUpload(previewVideoKey, 'preview')"
              [disabled]="uploadProgress['preview'] === 100"
              matTooltip="Pause upload"
            >
              <mat-icon>pause</mat-icon>
            </button>
            } @else {
            <button
              mat-icon-button
              (click)="resumeUpload(previewVideoKey, 'preview')"
              [disabled]="uploadProgress['preview'] === 100"
              matTooltip="Resume upload"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            }
            <button
              mat-icon-button
              (click)="cancelUpload(previewVideoKey, 'preview')"
              [disabled]="uploadProgress['preview'] === 100"
              matTooltip="Cancel upload"
            >
              <mat-icon>cancel</mat-icon>
            </button>
          </div>
          }
          <p>
            <span
              >{{
                uploadProgress["preview"] === 100 ? "Uploaded" : "Uploading"
              }} </span
            >{{ uploadProgress["preview"] }}%
          </p>
        </div>
      </div>
      } @else {
      <div
        class="upload-area"
        (click)="triggerFileInput('previewVideo')"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'preview')"
      >
        <input
          type="file"
          #previewFileInput
          id="previewVideo"
          formControlName="previewvideo"
          (change)="onPreviewVideoSelected($event)"
          accept="video/*"
          class="form-control-file"
        />
      </div>

      } @if(previewErrorMessage()) {
      <mat-error>{{ previewErrorMessage() }}</mat-error>
      } @if (previewFileURL) {
      <div class="preview-container">
        <video
          class="previewMedia"
          [src]="previewFileURL"
          alt="Preview video"
          controls
          preload="metadata"
        ></video>
      </div>
      }
    </div>

    <!-- Full Video -->
    <div class="form-field-container upload-section">
      <label for="fullVideo" class="upload-label">
        <mat-icon>theaters</mat-icon>
        Full Video
      </label>
      @if (fullVideoKey && uploadProgress['full'] === 100) {
      <div class="existing-file">
        <div class="file-info">
          <mat-icon>video_file</mat-icon>
          <span>{{ fullVideoKey.split("/").pop() }}</span>
        </div>
        <button
          mat-icon-button
          matTooltip="remove"
          (click)="deleteMedia(fullVideoKey, 'fullFileURL', 'fullVideoKey')"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      } @else if (uploadProgress['full'] && uploadProgress['full'] > 0 &&
      uploadProgress['full'] < 100) {
      <div class="progress">
        <div class="progress-header">
          <mat-icon>cloud_upload</mat-icon>
          <span>Uploading full video...</span>
        </div>
        <mat-progress-bar mode="determinate" [value]="uploadProgress['full']">
        </mat-progress-bar>
        <div class="progress-info">
          @if (uploadProgress["full"] !== 100) {
          <div class="upload-controls">
            @if (!isPaused['full']) {
            <button
              mat-icon-button
              (click)="pauseUpload(fullVideoKey, 'full')"
              [disabled]="uploadProgress['full'] === 100"
              matTooltip="Pause upload"
            >
              <mat-icon>pause</mat-icon>
            </button>
            } @else {
            <button
              mat-icon-button
              (click)="resumeUpload(fullVideoKey, 'full')"
              [disabled]="uploadProgress['full'] === 100"
              matTooltip="Resume upload"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            }
            <button
              mat-icon-button
              (click)="cancelUpload(fullVideoKey, 'full')"
              [disabled]="uploadProgress['full'] === 100"
              matTooltip="Cancel upload"
            >
              <mat-icon>cancel</mat-icon>
            </button>
          </div>
          }
          <p>
            <span
              >{{
                uploadProgress["full"] === 100 ? "Uploaded" : "Uploading"
              }} </span
            >{{ uploadProgress["full"] }}%
          </p>
        </div>
      </div>
      } @else {
      <div
        class="upload-area"
        (click)="triggerFileInput('fullVideo')"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event, 'full')"
      >
        <input
          type="file"
          #fullFileInput
          id="fullVideo"
          formControlName="fullvideo"
          (change)="onFullVideoSelected($event)"
          accept="video/*"
          class="form-control-file"
        />
      </div>

      } @if(fullErrorMessage()) {
      <mat-error>{{ fullErrorMessage() }}</mat-error>
      } @if (fullFileURL) {
      <div class="preview-container">
        <video
          class="previewMedia"
          [src]="fullFileURL"
          alt="Full video"
          controls
          preload="metadata"
        ></video>
      </div>
      }
    </div>
  </form>

  <div class="action-buttons">
    <button
      class="buttonTertiary"
      mat-button
      type="button"
      (click)="backButton()"
      [disabled]="isLoading() || isScheduling()"
    >
      Cancel
    </button>
    <button
      class="buttonSecondary"
      mat-raised-button
      type="button"
      (click)="publishContent(false)"
      [disabled]="uploadForm.invalid || isLoading() || isScheduling()"
    >
      {{ isScheduling() ? "Scheduling..." : "Schedule" }}
    </button>
    <button
      class="buttonPrimary"
      mat-raised-button
      type="submit"
      (click)="publishContent(true)"
      [disabled]="uploadForm.invalid || isLoading() || isScheduling()"
    >
      {{ isLoading() ? "Processing Video..." : "Process Video" }}
    </button>
  </div>
</div>
